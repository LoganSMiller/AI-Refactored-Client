// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Please follow strict StyleCop, ReSharper, and AI-Refactored code standards for all modifications.
// </auto-generated>

#nullable enable

namespace AIRefactored.AI.Missions
{
    using System;
    using AIRefactored.AI.Core;
    using AIRefactored.AI.Missions.Subsystems;
    using EFT;
    using UnityEngine;
    using Random = UnityEngine.Random;

    /// <summary>
    /// Central runtime mission handler.
    /// Coordinates bot objectives, mission switching, fallback, and extraction.
    /// Modularized into subsystems for maintainability and realism.
    /// </summary>
    public sealed class BotMissionController
    {
        private const float GroupRejoinTimeout = 20f;

        private readonly BotOwner _bot;
        private readonly BotComponentCache _cache;
        private readonly MissionEvaluator _evaluator;
        private readonly ObjectiveController _objectives;
        private readonly MissionSwitcher _switcher;
        private readonly MissionVoiceCoordinator _voice;

        private bool _forcedMission;
        private bool _inCombatPause;
        private float _groupWaitStart = -1f;

        private float _lastCombatTime;
        private float _lastUpdate;

        private MissionType _missionType;

        /// <summary>
        /// Defines major mission modes the bot can follow.
        /// </summary>
        public enum MissionType
        {
            Loot,
            Fight,
            Quest
        }

        /// <summary>
        /// Constructs and initializes the bot mission controller.
        /// </summary>
        public BotMissionController(BotOwner bot, BotComponentCache cache)
        {
            this._bot = bot ?? throw new ArgumentNullException(nameof(bot));
            this._cache = cache ?? throw new ArgumentNullException(nameof(cache));

            this._switcher = new MissionSwitcher(bot, cache);
            this._objectives = new ObjectiveController(bot, cache);
            this._evaluator = new MissionEvaluator(bot, cache);
            this._voice = new MissionVoiceCoordinator(bot);

            this._missionType = this.PickDefaultMission();
            this._objectives.SetInitialObjective(this._missionType);

            this._cache.AIRefactoredBotOwner?.SetMissionController(this);
        }

        /// <summary>
        /// Assigns a forced mission mode, disabling automatic switching.
        /// </summary>
        public void SetForcedMission(MissionType mission)
        {
            this._missionType = mission;
            this._forcedMission = true;
        }

        /// <summary>
        /// Updates the mission logic each frame.
        /// </summary>
        public void Tick(float time)
        {
            if (this._bot.IsDead || this._bot.GetPlayer == null || !this._bot.GetPlayer.HealthController?.IsAlive == true)
            {
                return;
            }

            if (this._cache.IsBlinded || (this._cache.PanicHandler?.IsPanicking ?? false))
            {
                return;
            }

            this._evaluator.UpdateStuckCheck(time);

            if (!this._forcedMission)
            {
                this._switcher.Evaluate(
                    ref this._missionType,
                    time,
                    this.SwitchToFight,
                    this._objectives.ResumeQuesting,
                    this._evaluator.IsGroupAligned);
            }

            if (this._cache.Combat?.IsInCombatState() == true)
            {
                this._lastCombatTime = time;

                if (this._missionType == MissionType.Quest)
                {
                    this._inCombatPause = true;
                }
            }

            if (this._inCombatPause && time - this._lastCombatTime > 4f)
            {
                this._inCombatPause = false;
                this._objectives.ResumeQuesting();
            }

            if ((this._missionType == MissionType.Loot || this._missionType == MissionType.Quest)
                && this._evaluator.ShouldExtractEarly())
            {
                this._evaluator.TryExtract();
                return;
            }

            if (!this._evaluator.IsGroupAligned() && this._missionType != MissionType.Fight)
            {

                if (this._groupWaitStart < 0f)
                {
                    this._groupWaitStart = time;
                }

                if (time - this._groupWaitStart < GroupRejoinTimeout)
                {
                    return;
                }

                this._groupWaitStart = -1f;
            }
            else
            {
                this._groupWaitStart = -1f;
            }

            if (time - this._lastUpdate > this.GetCooldown())
            {
                this._objectives.OnObjectiveReached(this._missionType);
                this._lastUpdate = time;
            }

            if (!this._inCombatPause &&
                Vector3.Distance(this._bot.Position, this._objectives.CurrentObjective) < 6f)
            {
                this.OnObjectiveReached();
            }
        }

        private void OnObjectiveReached()
        {
            if (this._missionType == MissionType.Loot)
            {
                this._cache.Movement?.EnterLootingMode();
                this._cache.PoseController?.LockCrouchPose();
                this._cache.LootScanner?.TryLootNearby();
                this._cache.DeadBodyScanner?.TryLootNearby();
                this._cache.Movement?.ExitLootingMode();
                this._voice.OnLoot();
            }

            this._objectives.OnObjectiveReached(this._missionType);
        }

        private MissionType PickDefaultMission()
        {
            EPlayerSide? side = this._bot.Profile?.Info?.Side;
            bool isPmc = side == EPlayerSide.Usec || side == EPlayerSide.Bear;

            BotPersonalityProfile? profile = BotRegistry.TryGet(this._bot.ProfileId);
            if (profile?.PreferredMission == null)
            {
                return this.RandomizeDefault(isPmc);
            }

            switch (profile.PreferredMission)
            {
                case MissionBias.Quest:
                    return isPmc ? MissionType.Quest : MissionType.Loot;
                case MissionBias.Fight:
                    return MissionType.Fight;
                case MissionBias.Loot:
                    return MissionType.Loot;
                default:
                    return this.RandomizeDefault(isPmc);
            }
        }

        private MissionType RandomizeDefault(bool isPmc)
        {
            int roll = Random.Range(0, 100);
            if (roll < 30)
            {
                return MissionType.Loot;
            }

            if (roll < 65)
            {
                return MissionType.Fight;
            }

            return isPmc ? MissionType.Quest : MissionType.Loot;
        }

        private void SwitchToFight()
        {
            this._missionType = MissionType.Fight;
            this._objectives.SetInitialObjective(this._missionType);
            this._voice.OnMissionSwitch();
        }

        private float GetCooldown()
        {
            return 10f + Random.Range(0f, 5f);
        }
    }
}
