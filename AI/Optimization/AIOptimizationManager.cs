// <auto-generated>
//   AI-Refactored: AIOptimizationManager.cs (Supreme Overlay Arbitration/Event-Only, Absolute Ultra-Realism+, June 2025)
//   Centralized, pooled, event-only, max-personality/squad overlay optimization for AIRefactored bots.
//   No tick/per-frame/coroutine logic. Bulletproof, no disables, error-isolated, 100% multiplayer/headless safe.
//   Max features: escalation, de-escalation, squad overlays, aggression tuning, event-driven voice/fakeout, threat/fatigue, and expansion hooks.
//   MIT License.
// </auto-generated>

namespace AIRefactored.AI.Optimization
{
    using System;
    using System.Collections.Generic;
    using AIRefactored.AI.Core;
    using AIRefactored.Core;
    using AIRefactored.Runtime;
    using BepInEx.Logging;
    using EFT;
    using UnityEngine;

    /// <summary>
    /// Supreme centralized overlay/event-based optimization, escalation, and realism controller for all AIRefactored bots.
    /// - Event-only (no tick/coroutine/interval logic)
    /// - Bulletproof: never disables, never cascades error, never null-propagates.
    /// - Pooled, squad/personality/fatigue/urgency-aware. Humanized overlays, ready for further expansion.
    /// </summary>
    public static class AIOptimizationManager
    {
        #region Constants

        private const float EscalationCooldownTime = 10.0f;
        private const float EscalationRandomVariance = 0.11f;
        private const float MaxGlobalMindDist = 800f;
        private const float MinGlobalMindDist = 180f;
        private const float MaxLookAtMeAngle = 80f;
        private const float MinLookAtMeAngle = 5f;
        private const float MaxRunChance = 100f;
        private const float MinRunChance = 0f;
        private const float PersonalityAggressionBias = 0.15f;
        private const float PersonalityCautionBias = 0.14f;
        private const float OverlayRandomCooldown = 3.5f;
        private const float OverlayRandomCooldownJitter = 1.1f;
        private const float FatigueDeescalateThreshold = 0.83f;
        private const float SquadTriggerChance = 0.19f;
        private const float MaxVoiceChance = 0.17f;

        #endregion

        #region Fields

        private static readonly BotAIOptimization Optimizer = new BotAIOptimization();
        private static readonly Dictionary<int, bool> BotOptimizationState = new Dictionary<int, bool>(128);
        private static readonly Dictionary<int, float> LastEscalationTimes = new Dictionary<int, float>(128);
        private static readonly Dictionary<int, float> LastOverlayTune = new Dictionary<int, float>(128);
        private static readonly ManualLogSource Logger = Plugin.LoggerInstance;

        #endregion

        #region Public API

        /// <summary>
        /// Overlay/event-only: Applies pooled optimization overlays to a bot, once per life.
        /// </summary>
        public static void Apply(BotOwner bot)
        {
            try
            {
                if (!GameWorldHandler.IsLocalHost() || !IsValid(bot))
                    return;

                int id = bot.GetInstanceID();
                if (BotOptimizationState.TryGetValue(id, out var opt) && opt)
                    return;

                Optimizer.Optimize(bot);
                BotOptimizationState[id] = true;
            }
            catch (Exception ex)
            {
                Logger.LogError("[AIOptimizationManager] Optimization failed for bot " + GetName(bot) + ": " + ex);
            }
        }

        /// <summary>
        /// Overlay/event-only: Resets optimization overlays on a bot (e.g. on death/teardown).
        /// </summary>
        public static void Reset(BotOwner bot)
        {
            try
            {
                if (!GameWorldHandler.IsLocalHost() || !IsValid(bot))
                    return;

                int id = bot.GetInstanceID();
                if (!BotOptimizationState.TryGetValue(id, out var opt) || !opt)
                    return;

                Optimizer.ResetOptimization(bot);
                BotOptimizationState[id] = false;
            }
            catch (Exception ex)
            {
                Logger.LogError("[AIOptimizationManager] Reset failed for bot " + GetName(bot) + ": " + ex);
            }
        }

        /// <summary>
        /// Overlay/event-only: Escalates bot threat perception, urgency, and responsiveness. 
        /// Micro-randomized, personality-driven, squad/fatigue-aware, locally pooled. No tick logic.
        /// </summary>
        public static void TriggerEscalation(BotOwner bot)
        {
            try
            {
                if (!GameWorldHandler.IsLocalHost() || !IsValid(bot))
                    return;

                int id = bot.GetInstanceID();
                float now = Time.time;
                if (LastEscalationTimes.TryGetValue(id, out float lastTime) && (now - lastTime) < EscalationCooldownTime)
                    return;

                var mind = GetMindSettings(bot);
                if (mind == null)
                {
                    Logger.LogWarning("[AIOptimizationManager] Escalation aborted: missing mind settings for bot: " + GetName(bot));
                    return;
                }

                var cache = GetCache(bot);
                var profile = cache?.AIRefactoredBotOwner?.PersonalityProfile
                              ?? (!string.IsNullOrEmpty(bot?.ProfileId) ? BotRegistry.Get(bot.ProfileId) : null);

                float aggression = profile?.AggressionLevel ?? 0.5f;
                float caution = profile?.Caution ?? 0.5f;
                float composure = cache?.PanicHandler?.GetComposureLevel() ?? 1f;
                float variance = 1f + UnityEngine.Random.Range(-EscalationRandomVariance, EscalationRandomVariance);

                // Max realism: Deescalate if extreme fatigue (simulates suppression/fear/shock)
                if (composure < 0.20f)
                {
                    mind.DIST_TO_FOUND_SQRT = Mathf.Clamp(mind.DIST_TO_FOUND_SQRT * 0.95f, MinGlobalMindDist, MaxGlobalMindDist);
                    mind.ENEMY_LOOK_AT_ME_ANG = Mathf.Clamp(mind.ENEMY_LOOK_AT_ME_ANG * 1.10f, MinLookAtMeAngle, MaxLookAtMeAngle);
                    mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 = Mathf.Clamp(mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 - 11f, MinRunChance, MaxRunChance);

                    if (cache?.GroupComms != null && UnityEngine.Random.value < MaxVoiceChance)
                        cache.GroupComms.Say(EPhraseTrigger.HoldPosition);

                    LastEscalationTimes[id] = now;
                    Logger.LogDebug($"[AIOptimizationManager] De-escalation triggered by fatigue for bot: {GetName(bot)}");
                    return;
                }

                // Escalate mind settings (threat, responsiveness, aggression)
                mind.DIST_TO_FOUND_SQRT = Mathf.Clamp(
                    mind.DIST_TO_FOUND_SQRT * (1.23f + aggression * PersonalityAggressionBias) * variance,
                    MinGlobalMindDist, MaxGlobalMindDist);
                mind.ENEMY_LOOK_AT_ME_ANG = Mathf.Clamp(
                    mind.ENEMY_LOOK_AT_ME_ANG * (0.7f - caution * PersonalityCautionBias) * variance,
                    MinLookAtMeAngle, MaxLookAtMeAngle);
                mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 = Mathf.Clamp(
                    mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 + 19f + aggression * 7.5f - caution * 4.5f,
                    MinRunChance, MaxRunChance);

                LastEscalationTimes[id] = now;
                LastOverlayTune[id] = now + OverlayRandomCooldown + UnityEngine.Random.Range(0f, OverlayRandomCooldownJitter);

                // Squad-aware escalation/fakeout overlays (no move/logic disables)
                if (cache?.GroupComms != null && UnityEngine.Random.value < SquadTriggerChance)
                {
                    var phrase = UnityEngine.Random.value < 0.48f ? EPhraseTrigger.Regroup : EPhraseTrigger.Cooperation;
                    cache.GroupComms.Say(phrase);
                }
                if (cache?.ThreatSelector != null && cache.ThreatSelector.CurrentTarget != null)
                {
                    if (UnityEngine.Random.value < 0.075f && cache.GroupComms != null)
                        cache.GroupComms.Say(EPhraseTrigger.OnEnemyGrenade);
                }
                Logger.LogDebug($"[AIOptimizationManager] Escalation overlays completed for bot: {GetName(bot)}");
            }
            catch (Exception ex)
            {
                Logger.LogError("[AIOptimizationManager] Escalation error for bot " + GetName(bot) + ": " + ex);
            }
        }

        /// <summary>
        /// Overlay/event-only: Triggers randomized overlay tuning for bot (aggression, voice, fakeout, caution overlays).
        /// Never disables, only overlays. No tick logic.
        /// </summary>
        public static void TriggerOverlayRandomization(BotOwner bot)
        {
            try
            {
                if (!IsValid(bot)) return;
                int id = bot.GetInstanceID();
                float now = Time.time;
                if (LastOverlayTune.TryGetValue(id, out float last) && now < last)
                    return;

                var cache = GetCache(bot);
                if (cache == null) return;

                // Rare, randomized squad/fakeout overlays (no spam, overlays only)
                if (cache.GroupComms != null && UnityEngine.Random.value < MaxVoiceChance)
                {
                    EPhraseTrigger phrase;
                    float v = UnityEngine.Random.value;
                    if (v < 0.35f)
                        phrase = EPhraseTrigger.Cooperation;
                    else if (v < 0.68f)
                        phrase = EPhraseTrigger.HoldPosition;
                    else
                        phrase = EPhraseTrigger.FollowMe;

                    cache.GroupComms.Say(phrase);
                }

                // Overlay voice/fakeout for live combat or escalation events
                if (cache.ThreatSelector != null && cache.ThreatSelector.CurrentTarget != null)
                {
                    if (UnityEngine.Random.value < 0.09f && cache.GroupComms != null)
                        cache.GroupComms.Say(EPhraseTrigger.OnEnemyGrenade);
                }

                Logger.LogDebug($"[AIOptimizationManager] Overlay randomization triggered for bot: {GetName(bot)}");
                LastOverlayTune[id] = now + OverlayRandomCooldown + UnityEngine.Random.Range(0f, OverlayRandomCooldownJitter);
            }
            catch (Exception ex)
            {
                Logger.LogError("[AIOptimizationManager] OverlayRandomization error for bot " + GetName(bot) + ": " + ex);
            }
        }

        #endregion

        #region Internal Helpers

        private static bool IsValid(BotOwner bot)
        {
            try
            {
                return bot != null && !bot.IsDead && bot.GetPlayer is Player player && player.IsAI;
            }
            catch { return false; }
        }

        private static string GetName(BotOwner bot)
        {
            try { return bot?.Profile?.Info?.Nickname ?? bot?.ProfileId ?? "Unknown"; }
            catch { return "Unknown"; }
        }

        private static BotGlobalsMindSettings GetMindSettings(BotOwner bot)
        {
            try
            {
                return bot?.Settings?.FileSettings?.Mind;
            }
            catch { return null; }
        }

        private static BotComponentCache GetCache(BotOwner bot)
        {
            if (bot == null) return null;
            if (!string.IsNullOrEmpty(bot.ProfileId))
            {
                BotComponentCacheRegistry.TryGet(bot.ProfileId, out var cache);
                return cache;
            }
            return null;
        }

        #endregion
    }
}
