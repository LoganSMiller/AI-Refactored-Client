// <auto-generated>
//   AI-Refactored: BotSoundRegistry.cs (Supreme Arbitration Overlay/Event Edition, June 2025 – Max Realism, Stutter-Proof)
//   All positional queries via EFTPlayerUtil.GetPosition. No direct Transform/Position access. 
//   Voice comms/event triggers are one-shot, overlay/event only, stateless, and echo/stutter proof.
//   All logic is tick-free, error-contained, multiplayer/headless safe, and bulletproof. MIT License.
// </auto-generated>

namespace AIRefactored.AI.Helpers
{
    using System;
    using System.Collections.Generic;
    using AIRefactored.AI.Core;
    using AIRefactored.Core;
    using EFT;
    using UnityEngine;

    /// <summary>
    /// Central registry for sound events: gunfire, footsteps, and sound perception zones.
    /// Bulletproof, stateless, position-safe, voice-safe, and multiplayer/headless compliant.
    /// No per-tick/coroutine, no side effects—only overlay/event triggers.
    /// </summary>
    public static class BotSoundRegistry
    {
        #region Constants

        private const float DefaultHearingRadius = 30f;

        #endregion

        #region State

        private static readonly Dictionary<string, float> FootstepTimestamps = new Dictionary<string, float>(64);
        private static readonly Dictionary<string, float> ShotTimestamps = new Dictionary<string, float>(64);
        private static readonly Dictionary<string, Vector3> SoundZones = new Dictionary<string, Vector3>(64);

        // One-shot error log suppressors.
        private static bool _hasLoggedNullPlayer;
        private static bool _hasLoggedInvalidPosition;
        private static bool _hasLoggedCacheError;

        #endregion

        #region Public API

        /// <summary>
        /// Clears all sound/event data (for raid teardown/reset).
        /// </summary>
        public static void Clear()
        {
            FootstepTimestamps.Clear();
            ShotTimestamps.Clear();
            SoundZones.Clear();
            _hasLoggedNullPlayer = false;
            _hasLoggedInvalidPosition = false;
            _hasLoggedCacheError = false;
        }

        /// <summary>
        /// True if the player fired within the specified window (event/overlay only).
        /// </summary>
        public static bool FiredRecently(Player player, float withinSeconds = 1.5f, float now = -1f)
        {
            return TryGetLastShot(player, out float time) &&
                   ((now >= 0f ? now : Time.time) - time <= withinSeconds);
        }

        /// <summary>
        /// True if the player stepped within the specified window (event/overlay only).
        /// </summary>
        public static bool SteppedRecently(Player player, float withinSeconds = 1.2f, float now = -1f)
        {
            return TryGetLastStep(player, out float time) &&
                   ((now >= 0f ? now : Time.time) - time <= withinSeconds);
        }

        /// <summary>
        /// Registers a gunshot event for a player (overlay/event only).
        /// </summary>
        public static void NotifyShot(Player player)
        {
            try
            {
                if (!EFTPlayerUtil.IsValid(player))
                {
                    if (!_hasLoggedNullPlayer)
                    {
                        Plugin.LoggerInstance.LogWarning("[BotSoundRegistry] NotifyShot: Invalid player.");
                        _hasLoggedNullPlayer = true;
                    }
                    return;
                }

                string id = player.ProfileId;
                if (string.IsNullOrEmpty(id)) return;

                ShotTimestamps[id] = Time.time;

                Vector3 pos = EFTPlayerUtil.GetPosition(player);
                if (!IsValidVector(pos))
                {
                    if (!_hasLoggedInvalidPosition)
                    {
                        Plugin.LoggerInstance.LogWarning("[BotSoundRegistry] NotifyShot: Invalid player position.");
                        _hasLoggedInvalidPosition = true;
                    }
                    return;
                }

                SoundZones[id] = pos;
                TriggerSquadPing(id, pos, isGunshot: true);
            }
            catch (Exception ex)
            {
                Plugin.LoggerInstance.LogError($"[BotSoundRegistry] NotifyShot failed: {ex}");
            }
        }

        /// <summary>
        /// Registers a footstep event for a player (overlay/event only).
        /// </summary>
        public static void NotifyStep(Player player)
        {
            try
            {
                if (!EFTPlayerUtil.IsValid(player))
                {
                    if (!_hasLoggedNullPlayer)
                    {
                        Plugin.LoggerInstance.LogWarning("[BotSoundRegistry] NotifyStep: Invalid player.");
                        _hasLoggedNullPlayer = true;
                    }
                    return;
                }

                string id = player.ProfileId;
                if (string.IsNullOrEmpty(id)) return;

                FootstepTimestamps[id] = Time.time;

                Vector3 pos = EFTPlayerUtil.GetPosition(player);
                if (!IsValidVector(pos))
                {
                    if (!_hasLoggedInvalidPosition)
                    {
                        Plugin.LoggerInstance.LogWarning("[BotSoundRegistry] NotifyStep: Invalid player position.");
                        _hasLoggedInvalidPosition = true;
                    }
                    return;
                }

                SoundZones[id] = pos;
                TriggerSquadPing(id, pos, isGunshot: false);
            }
            catch (Exception ex)
            {
                Plugin.LoggerInstance.LogError($"[BotSoundRegistry] NotifyStep failed: {ex}");
            }
        }

        /// <summary>
        /// Gets the last known shot event timestamp for a player (overlay/event only).
        /// </summary>
        public static bool TryGetLastShot(Player player, out float time)
        {
            time = -1f;
            if (!EFTPlayerUtil.IsValid(player)) return false;
            return ShotTimestamps.TryGetValue(player.ProfileId, out time);
        }

        /// <summary>
        /// Gets the last known step event timestamp for a player (overlay/event only).
        /// </summary>
        public static bool TryGetLastStep(Player player, out float time)
        {
            time = -1f;
            if (!EFTPlayerUtil.IsValid(player)) return false;
            return FootstepTimestamps.TryGetValue(player.ProfileId, out time);
        }

        /// <summary>
        /// Gets the last known position associated with a player's sound event.
        /// </summary>
        public static bool TryGetSoundPosition(Player player, out Vector3 pos)
        {
            pos = Vector3.zero;
            return EFTPlayerUtil.IsValid(player) &&
                   SoundZones.TryGetValue(player.ProfileId, out pos);
        }

        #endregion

        #region Internal

        /// <summary>
        /// Triggers squad comms for all nearby bots (within hearing range), stutter/echo-proof. Overlay/event only.
        /// </summary>
        private static void TriggerSquadPing(string sourceId, Vector3 location, bool isGunshot)
        {
            try
            {
                float radiusSq = DefaultHearingRadius * DefaultHearingRadius;

                foreach (var cache in BotCacheUtility.AllActiveBots())
                {
                    try
                    {
                        if (cache?.Bot == null || cache.Bot.IsDead)
                            continue;

                        if (cache.Bot.ProfileId == sourceId)
                            continue;

                        Vector3 pos = EFTPlayerUtil.GetPosition(cache.Bot.GetPlayer);
                        if (!IsValidVector(pos) || (pos - location).sqrMagnitude > radiusSq)
                            continue;

                        cache.RegisterHeardSound(location);

                        if (cache.GroupComms != null)
                        {
                            if (isGunshot)
                                cache.GroupComms.SaySuppression();
                            else
                                cache.GroupComms.SayFallback();
                        }
                    }
                    catch (Exception innerEx)
                    {
                        if (!_hasLoggedCacheError)
                        {
                            Plugin.LoggerInstance.LogWarning($"[BotSoundRegistry] TriggerSquadPing cache error: {innerEx}");
                            _hasLoggedCacheError = true;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Plugin.LoggerInstance.LogError($"[BotSoundRegistry] TriggerSquadPing outer error: {ex}");
            }
        }

        /// <summary>
        /// True if the vector is valid for event/registry use.
        /// </summary>
        private static bool IsValidVector(Vector3 v)
        {
            return !float.IsNaN(v.x) && !float.IsInfinity(v.x) &&
                   !float.IsNaN(v.y) && !float.IsInfinity(v.y) &&
                   !float.IsNaN(v.z) && !float.IsInfinity(v.z) &&
                   (v.x != 0f || v.y != 0f || v.z != 0f) &&
                   Mathf.Abs(v.x) < 40000f && Mathf.Abs(v.y) < 40000f && Mathf.Abs(v.z) < 40000f;
        }

        #endregion
    }
}
