// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Please follow strict StyleCop, ReSharper, and AI-Refactored code standards for all modifications.
// </auto-generated>

namespace AIRefactored.Core
{
    using System.Collections.Generic;
    using AIRefactored.Bootstrap;
    using AIRefactored.Runtime;
    using EFT;
    using EFT.HealthSystem;
    using UnityEngine;

    /// <summary>
    /// Provides null-safe and Dissonance-free helpers for resolving EFT.Player and BotOwner references.
    /// Used throughout AI-Refactored for profile resolution, spatial lookups, and bot filtering.
    /// </summary>
    public static class EFTPlayerUtil
    {
        #region Resolution

        public static Player AsEFTPlayer(IPlayer raw)
        {
            return raw is Player cast ? cast : null;
        }

        public static bool TryGetValidPlayer(IPlayer raw, out Player player)
        {
            if (raw is Player cast && IsValid(cast))
            {
                player = cast;
                return true;
            }

            player = null;
            return false;
        }

        public static IPlayer AsSafeIPlayer(Player player)
        {
            return player is IPlayer cast ? cast : null;
        }

        public static Player ResolvePlayer(BotOwner bot)
        {
            return bot != null ? bot.GetPlayer as Player : null;
        }

        public static Player ResolvePlayerById(string profileId)
        {
            if (string.IsNullOrEmpty(profileId) || !WorldInitState.IsInPhase(WorldPhase.WorldReady))
            {
                return null;
            }

            GameWorld world = GameWorldHandler.Get();
            if (world == null)
            {
                return null;
            }

            List<Player> players = world.AllAlivePlayersList;
            if (players == null)
            {
                return null;
            }

            for (int i = 0; i < players.Count; i++)
            {
                Player p = players[i];
                if (p != null && p.ProfileId == profileId)
                {
                    return p;
                }
            }

            return null;
        }

        #endregion

        #region Validity + Info

        public static bool IsValid(Player player)
        {
            return player != null &&
                   player.HealthController != null &&
                   player.HealthController.IsAlive &&
                   player.Transform != null &&
                   player.Transform.Original != null;
        }

        public static bool IsValidGroupPlayer(Player player)
        {
            return IsValid(player);
        }

        public static bool IsBot(Player player)
        {
            return player != null && player.IsAI;
        }

        public static EPlayerSide GetSide(Player player)
        {
            return player != null ? player.Side : EPlayerSide.Savage;
        }

        public static string GetProfileId(BotOwner bot)
        {
            Player player = bot != null ? bot.GetPlayer : null;
            return player != null ? player.ProfileId : string.Empty;
        }

        public static bool IsValidBotOwner(BotOwner bot)
        {
            Player player = bot != null ? bot.GetPlayer : null;

            return player != null &&
                   bot.Memory != null &&
                   bot.WeaponManager != null &&
                   bot.BotsGroup != null;
        }

        public static bool HasValidMovementContext(BotOwner bot)
        {
            Player player = bot != null ? bot.GetPlayer : null;
            return player != null && player.MovementContext != null;
        }

        public static bool IsFikaHeadlessSafe(BotOwner bot)
        {
            Player player = bot != null ? bot.GetPlayer : null;

            return player != null &&
                   player.IsAI &&
                   player.HealthController != null &&
                   player.HealthController.IsAlive;
        }

        #endregion

        #region Spatial

        public static Transform GetTransform(Player player)
        {
            return player != null ? player.Transform?.Original : null;
        }

        public static Vector3 GetPosition(Player player)
        {
            Transform t = GetTransform(player);
            return t != null ? t.position : Vector3.zero;
        }

        #endregion

        #region Combat Logic

        public static bool IsEnemyOf(BotOwner self, Player target)
        {
            if (self == null || target == null)
            {
                return false;
            }

            BotsGroup group = self.BotsGroup;
            if (group == null)
            {
                return false;
            }

            IPlayer iTarget = AsSafeIPlayer(target);
            return iTarget != null && group.IsEnemy(iTarget);
        }

        public static bool AreEnemies(Player a, Player b)
        {
            return a != null &&
                   b != null &&
                   a.ProfileId != b.ProfileId &&
                   a.Side != b.Side;
        }

        #endregion
    }
}
