// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Please follow strict StyleCop, ReSharper, and AI-Refactored code standards for all modifications.
// </auto-generated>

#nullable enable

namespace AIRefactored
{
    using System;
    using System.Collections;

    using AIRefactored.AI.Core;
    using AIRefactored.AI.Optimization;
    using AIRefactored.Bootstrap;
    using AIRefactored.Core;
    using AIRefactored.Runtime;
    using BepInEx;
    using BepInEx.Logging;
    using Comfort.Common;
    using EFT;
    using Fika.Core;
    using UnityEngine;

    /// <summary>
    /// Entry point for AI-Refactored mod. Registers world bootstrap, logging, and AI system hooks.
    /// Supports both headless and client-hosted environments with full parity.
    /// </summary>
    [BepInPlugin("com.spock.airefactored", "AI-Refactored", "1.0.0")]
    public sealed class Plugin : BaseUnityPlugin
    {
        #region Static Fields

        private static ManualLogSource? _log;

        private static bool _isWorldInitialized = false;

        #endregion

        #region Properties

        /// <summary>
        /// Gets the global logger instance.
        /// </summary>
        public static ManualLogSource LoggerInstance =>
            _log ?? throw new InvalidOperationException("[AIRefactored] Logger could not be initialized.");

        #endregion

        #region Unity Lifecycle

        private void Awake()
        {
            try
            {
                _log = this.Logger ?? throw new InvalidOperationException("[AIRefactored] Logger could not be initialized.");
                _log.LogInfo("[AIRefactored] [Init] Plugin starting...");

                // Initialize AI-Refactored Controller and perform other setup
                AIRefactoredController.Initialize(_log);
                BotWorkScheduler.AutoInjectFlushHost();

                // Prevent unnecessary repeated initialization or component addition
                if (!_isWorldInitialized)
                {
                    InitializeWorldAndBots();
                    _isWorldInitialized = true;  // Flag to prevent re-initialization
                }

                _log.LogInfo("[AIRefactored] [Init] Plugin startup complete.");
            }
            catch (Exception ex)
            {
                _log?.LogError($"[AIRefactored] [Init] Error during initialization: {ex.Message}\n{ex.StackTrace}");
                throw; // Rethrow to ensure the crash is captured
            }
        }

        private void OnDestroy()
        {
            try
            {
                if (FikaHeadlessDetector.IsHeadless)
                {
                    _log?.LogInfo("[AIRefactored] [Shutdown] Headless environment detected, skipping bot spawn unhook.");
                }
                else
                {
                    GameWorldHandler.UnhookBotSpawns(); // Referencing GameWorldHandler from EFT
                }
                _log?.LogInfo("[AIRefactored] [Shutdown] Plugin shutdown complete.");
            }
            catch (Exception ex)
            {
                _log?.LogError($"[AIRefactored] [Shutdown] Error during shutdown: {ex.Message}\n{ex.StackTrace}");
            }
        }

        #endregion

        #region Initialization Logic

        /// <summary>
        /// Initializes world and bot systems, ensuring proper handling of headless and non-headless environments.
        /// </summary>
        private void InitializeWorldAndBots()
        {
            try
            {
                _log?.LogInfo("[AIRefactored] Initializing world and bot systems...");

                // Ensure headless compatibility by checking FikaHeadlessDetector
                if (FikaHeadlessDetector.IsHeadless)
                {
                    _log?.LogInfo("[AIRefactored] [Bootstrap] Headless environment detected. Bot spawn logic will be handled in headless mode.");
                    GameWorldHandler.TryInitializeWorld(); // Just initialize the world systems, no bot spawns
                    GameWorldHandler.HookBotSpawns(); // Hook bot spawns even in headless mode to support AI logic
                }
                else
                {
                    GameWorldHandler.TryInitializeWorld(); // Initialize world systems normally
                    WorldBootstrapper.TryInitialize(); // Initialize world bootstrapper for non-headless environment

                    GameWorldHandler.HookBotSpawns(); // Hook bot spawns for non-headless environments
                    _log?.LogInfo("[AIRefactored] [Bootstrap] World systems and bot spawns initialized.");
                }
            }
            catch (Exception ex)
            {
                _log?.LogError($"[AIRefactored] [Bootstrap] Error during world/bot initialization: {ex.Message}\n{ex.StackTrace}");
            }
        }

        #endregion

        #region Coroutine Utilities

        /// <summary>
        /// A safe coroutine implementation with exception handling to ensure that errors don't stop the flow.
        /// </summary>
        private IEnumerator SafeCoroutine(IEnumerator routine)
        {
            while (true)
            {
                object? current;

                try
                {
                    if (!routine.MoveNext())
                    {
                        yield break;
                    }

                    current = routine.Current;
                }
                catch (Exception ex)
                {
                    _log?.LogError($"[AIRefactored] [SafeCoroutine] Exception: {ex.Message}\n{ex.StackTrace}");
                    yield break;
                }

                yield return current;
            }
        }

        #endregion
    }
}
